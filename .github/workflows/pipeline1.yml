name: DevSecOps Pipeline - PetClinic

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # ====================
  # 1. Build & Tests (VM1 - Runner CI)
  # ====================
  build-test:
    runs-on: self-hosted
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests=false

      - name: Run Unit Tests
        run: mvn test

  # ====================
  # 2. Analyse statique (SonarQube + Semgrep)
  # ====================
  static-analysis:
    runs-on: self-hosted
    needs: build-test
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: SonarQube Scan
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
            -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
            -v $(pwd):/usr/src sonarsource/sonar-scanner-cli

      - name: Semgrep Scan
        run: |
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep --config=auto /src

  # ====================
  # 3. Analyse de composition logicielle (SCA - Trivy, Syft)
  # ====================
  sca-scan:
    runs-on: self-hosted
    needs: static-analysis
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Syft SBOM
        run: |
          docker run --rm -v $(pwd):/src anchore/syft:latest dir:/src -o json > sbom.json

      - name: Trivy FS Scan
        run: |
          docker run --rm -v $(pwd):/src aquasec/trivy fs /src

  # ====================
  # 4. Packaging & Scan image
  # ====================
  package-and-scan:
    runs-on: self-hosted
    needs: sca-scan
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t myapp:latest .

      - name: Trivy Image Scan
        run: docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image myapp:latest

      - name: Push to Harbor
        run: |
          echo ${{ secrets.HARBOR_PASSWORD }} | docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} --password-stdin
          docker tag myapp:latest ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest
          docker push ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest

  # ====================
  # 5. Déploiement Préprod (VM3)
  # ====================
  deploy-preprod:
    runs-on: self-hosted
    needs: package-and-scan
    steps:
      - name: Pull Image from Harbor
        run: |
          docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} -p ${{ secrets.HARBOR_PASSWORD }}
          docker pull ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest
          docker run -d --rm -p 8081:8080 --name myapp-preprod ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest

      - name: OWASP ZAP Scan
        run: |
          docker run --rm -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:8081

      - name: Load Testing with K6
        run: |
          docker run --rm -i loadimpact/k6 run - <tests/load-test.js

  # ====================
  # 6. Validation manuelle
  # ====================
  manual-approval:
    runs-on: self-hosted
    needs: deploy-preprod
    steps:
      - name: Wait for manual approval
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # ====================
  # 7. Déploiement Production (VM4)
  # ====================
  deploy-prod:
    runs-on: self-hosted
    needs: manual-approval
    steps:
      - name: Pull Image from Harbor
        run: |
          docker login ${{ secrets.HARBOR_URL }} -u ${{ secrets.HARBOR_USERNAME }} -p ${{ secrets.HARBOR_PASSWORD }}
          docker pull ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest
          docker run -d --rm -p 8080:8080 --name myapp-prod ${{ secrets.HARBOR_URL }}/devsecops/myapp:latest

  # ====================
  # 8. Supervision (Prometheus + Grafana sur VM2)
  # ====================
  monitoring:
    runs-on: self-hosted
    needs: deploy-prod
    steps:
      - name: Verify Monitoring
        run: |
          curl -s http://vm2:9090/api/v1/status/config  # Vérifier Prometheus
          curl -s http://vm2:3000/api/health            # Vérifier Grafana
