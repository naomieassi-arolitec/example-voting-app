name: DevSecOps Pipeline - Example Voting App

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  # ====================
  # 1. Build & Tests (VM1 - Runner)
  # ====================
  build-test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Images
        run: docker compose -f docker-compose.yml build

  # ====================
  # 2. Analyse statique (SonarQube SAST)
  # ====================
  sonar-analysis:
    runs-on: self-hosted
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - name: SonarQube Scan
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
            -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
            -v $(pwd):/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  # ====================
  # 3. Analyse de composition logicielle (SCA - Trivy, Syft)
  # ====================
  sca-scan:
    runs-on: self-hosted
    needs: build-test
    steps:
      - name: Trivy FS Scan
        run: |
          docker run --rm -v $(pwd):/src aquasec/trivy fs /src

  # ====================
  # 3. Packaging & Scan image
  # ====================
  package-and-scan:
    runs-on: self-hosted
    needs: [sonar-analysis, sca-scan]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Build & Push Docker image
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}//example-voting-app-$img:latest
          IMAGE_TAG=${{ github.sha }}
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG

      - name: Install Trivy CLI
        uses: aquasecurity/setup-trivy@v0.2.3
      - name: Trivy image scan
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}//example-voting-app-$img:latest
          IMAGE_TAG=${{ github.sha }}
          trivy image --severity HIGH,CRITICAL $IMAGE_NAME:$IMAGE_TAG
      - name: Trivy image scan (JSON)
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/example-voting-app-$img:latest
          IMAGE_TAG=${{ github.sha }}
          trivy image --severity HIGH,CRITICAL \
            --format json --output trivy-image.json $IMAGE_NAME:$IMAGE_TAG
      - name: Upload image scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image
          path: trivy-image.json
  
  # ====================
  # 4. Déploiement Préprod (VM2)
  # ====================
  deploy-preprod:
    runs-on: self-hosted
    needs: package-and-scan
    steps:
      - name: Deploy Preprod via Swarm
        run: ssh rocky@192.168.1.66 "docker stack deploy -c /home/user/docker-compose-preprod.yml votingapp-preprod"

      - name: OWASP ZAP Scan
        run: docker run --rm -t owasp/zap2docker-stable zap-baseline.py -t http://vm2:8081

  # ====================
  # 5. Validation manuelle
  # ====================
  manual-approval:
    runs-on: self-hosted
    needs: deploy-preprod
    steps:
      - name: Wait for manual approval
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # ====================
  # 6. Déploiement Production (VM3)
  # ====================
  deploy-prod:
    runs-on: self-hosted
    needs: manual-approval
    steps:
      - name: Deploy Production via Swarm
        run: ssh rocky@192.168.1.67 "docker stack deploy -c /home/user/docker-compose-prod.yml votingapp-prod"

  # ====================
  # 7. Supervision Monitoring (VM1)
  # ====================
  monitoring:
    runs-on: self-hosted
    needs: deploy-prod
    steps:
      - name: Verify Prometheus
        run: curl -s http://localhost:9090/api/v1/status/config
      - name: Verify Grafana
        run: curl -s http://localhost:3000/api/health
